                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const cron = require('node-cron');
const redisService = require('../services/redisService');

// Clean up expired sessions every hour
const sessionCleanupJob = cron.schedule('0 * * * *', async () => {
  try {
    console.log('Starting session cleanup job...');
    const cleanedCount = await redisService.cleanupExpiredSessions();
    console.log(`Session cleanup completed. Cleaned ${cleanedCount} expired sessions.`);
  } catch (error) {
    console.error('Session cleanup job failed:', error);
  }
}, {
  scheduled: false // Don't start automatically
});

// Health check job every 5 minutes
const healthCheckJob = cron.schedule('*/5 * * * *', async () => {
  try {
    const isHealthy = await redisService.healthCheck();
    if (!isHealthy) {
      console.error('Redis health check failed');
    }
  } catch (error) {
    console.error('Health check job failed:', error);
  }
}, {
  scheduled: false
});

// Start jobs
const startJobs = () => {
  sessionCleanupJob.start();
  healthCheckJob.start();
  console.log('Session cleanup and health check jobs started');
};

// Stop jobs
const stopJobs = () => {
  sessionCleanupJob.stop();
  healthCheckJob.stop();
  console.log('Session cleanup and health check jobs stopped');
};

module.exports = {
  startJobs,
  stopJobs
}; 